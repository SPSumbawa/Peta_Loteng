<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Peta BHUMI & RTRW Lombok Tengah - ATR/BPN</title>

  <!-- üü© CSS Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
      height: 100dvh;
    }

    #map.clickable {
      cursor: crosshair;
    }

    /* Loading Overlay - Splash Screen */
    .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-size: 200% 200%;
    animation: gradientShift 4s ease infinite;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    opacity: 1;
    transition: opacity 0.6s ease-out;
    }

    .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
    }

    .loading-overlay.fade-out {
    animation: fadeOut 0.6s ease-out forwards;
    }

    @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
    }

    @keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
    }

    /* Logo Container */
    .splash-logo {
    margin-bottom: 30px;
    animation: logoEntrance 1s ease-out;
    }

    @keyframes logoEntrance {
    from {
        transform: scale(0.5) rotate(-10deg);
        opacity: 0;
    }
    to {
        transform: scale(1) rotate(0deg);
        opacity: 1;
    }
    }

    .splash-icon {
    font-size: 80px;
    margin-bottom: 10px;
    animation: bounce 2s ease-in-out infinite;
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }

    @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    }

    /* Title & Subtitle */
    .splash-title {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 10px;
    text-align: center;
    text-shadow: 0 4px 12px rgba(0,0,0,0.3);
    letter-spacing: 1px;
    animation: slideDown 0.8s ease-out;
    }

    .splash-subtitle {
    font-size: 24px;
    font-weight: 400;
    margin-bottom: 40px;
    opacity: 0.95;
    text-align: center;
    animation: slideDown 1s ease-out;
    }

    @keyframes slideDown {
    from {
        transform: translateY(-30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
    }

    /* Credits Section */
    .splash-credits {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px 40px;
    margin-bottom: 40px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    animation: zoomIn 1.2s ease-out;
    }

    @keyframes zoomIn {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
    }

    .credits-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 15px;
    opacity: 0.9;
    text-align: center;
    }

    .credits-names {
    display: flex;
    flex-direction: column;
    gap: 12px;
    }

    .creator-name {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    padding: 8px 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    border-left: 4px solid #fff;
    transition: all 0.3s ease;
    animation: slideInLeft 1.4s ease-out;
    }

    .creator-name:nth-child(2) {
    animation: slideInRight 1.6s ease-out;
    border-left: none;
    border-right: 4px solid #fff;
    }

    @keyframes slideInLeft {
    from {
        transform: translateX(-50px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
    }

    @keyframes slideInRight {
    from {
        transform: translateX(50px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
    }

    /* Loading Spinner */
    .loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top: 5px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }

    /* Loading Text */
    .loading-text {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
    }

    .loading-progress {
    font-size: 14px;
    opacity: 0.9;
    font-weight: 400;
    }

    /* Decorative Elements */
    .splash-decoration {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    animation: float 6s ease-in-out infinite;
    }

    .decoration-1 {
    width: 100px;
    height: 100px;
    top: 10%;
    left: 10%;
    animation-delay: 0s;
    }

    .decoration-2 {
    width: 150px;
    height: 150px;
    bottom: 15%;
    right: 10%;
    animation-delay: 2s;
    }

    .decoration-3 {
    width: 80px;
    height: 80px;
    top: 60%;
    left: 5%;
    animation-delay: 4s;
    }

    @keyframes float {
    0%, 100% {
        transform: translateY(0px) scale(1);
    }
    50% {
        transform: translateY(-30px) scale(1.1);
    }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
    .splash-icon {
        font-size: 60px;
    }

    .splash-title {
        font-size: 24px;
    }

    .splash-subtitle {
        font-size: 14px;
        padding: 0 20px;
    }

    .splash-credits {
        padding: 20px 25px;
        margin: 0 20px 30px 20px;
    }

    .creator-name {
        font-size: 16px;
        padding: 6px 15px;
    }

    .credits-label {
        font-size: 11px;
    }

    .decoration-1, .decoration-2, .decoration-3 {
        display: none;
    }
    }

    @media (max-width: 480px) {
    .splash-title {
        font-size: 20px;
    }

    .splash-subtitle {
        font-size: 12px;
    }

    .creator-name {
        font-size: 14px;
    }

    .splash-credits {
        padding: 15px 20px;
    }
    }


    /* Modal Notifikasi Lokasi */
    .location-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .location-modal.hidden {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .location-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      width: 350px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .location-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .location-modal-icon {
      font-size: 48px;
    }

    .location-modal-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .location-modal-body {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .location-modal-buttons {
      display: flex;
      gap: 10px;
    }

    .location-modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      -webkit-tap-highlight-color: transparent;
    }

    .location-modal-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .location-modal-btn.primary:active {
      transform: scale(0.95);
      opacity: 0.8;
    }

    .location-modal-btn.secondary {
      background: #f0f0f0;
      color: #666;
    }

    .location-modal-btn.secondary:active {
      background: #e0e0e0;
    }

    /* Custom Layer Control */
    .custom-layer-control {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .layer-control-header {
      padding: 10px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    .layer-control-header:active {
      background: linear-gradient(135deg, #5568d3 0%, #6a4091 100%);
    }

    .layer-control-header .toggle-icon {
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    .layer-control-header .toggle-icon.expanded {
      transform: rotate(180deg);
    }

    .layer-control-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0;
    }

    .layer-control-body.expanded {
      max-height: 600px;
      padding: 10px;
      overflow-y: auto;
    }

    .layer-item {
      margin: 8px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .layer-item.active {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .layer-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .layer-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .layer-name {
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .layer-item.active .layer-name {
      color: #667eea;
    }

    .layer-opacity {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
      display: none;
    }

    .layer-item.active .layer-opacity {
      display: block;
    }

    .opacity-slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .opacity-slider-container label {
      font-size: 10px;
      color: #666;
      min-width: 35px;
    }

    .opacity-slider-container input[type="range"] {
      flex: 1;
      height: 25px;
    }

    .opacity-slider-container .opacity-value {
      font-size: 10px;
      font-weight: bold;
      color: #667eea;
      min-width: 35px;
      text-align: right;
    }

    /* Basemap Control */
    .basemap-control {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      overflow: hidden;
      margin-top: 10px;
    }

    .basemap-control-header {
      padding: 10px 12px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      font-weight: bold;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    .basemap-control-header:active {
      background: linear-gradient(135deg, #e082ea 0%, #e4465b 100%);
    }

    .basemap-control-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0;
    }

    .basemap-control-body.expanded {
      max-height: 200px;
      padding: 10px;
    }

    .basemap-item {
      padding: 8px;
      margin: 4px 0;
      background: #f9f9f9;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .basemap-item:active {
      background: #e0e0e0;
    }

    .basemap-item.active {
      border-color: #f093fb;
      background: #fff0f9;
    }

    .basemap-item input[type="radio"] {
      width: 18px;
      height: 18px;
    }

    .basemap-item label {
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
    }

    /* Legend */
    .legend-wms {
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      max-height: 300px;
      overflow-y: auto;
    }

    .legend-wms h4 {
      margin: 5px 0;
      font-size: 11px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 3px;
    }

    .legend-wms img {
      display: block;
      width: auto;
      height: auto;
      max-width: 150px;
    }

    /* Geolocation Button */
    .leaflet-control-locate {
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      cursor: pointer;
    }

    .leaflet-control-locate a {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #333;
      text-decoration: none;
      transition: all 0.3s;
      -webkit-tap-highlight-color: transparent;
    }

    .leaflet-control-locate a:hover {
      background: #f4f4f4;
      color: #667eea;
    }

    .leaflet-control-locate a:active {
      background: #e0e0e0;
    }

    .leaflet-control-locate a.loading {
      animation: pulse 1.5s infinite;
    }

    .leaflet-control-locate a.active {
      color: #4caf50;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Location marker custom */
    .location-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4285f4;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
    }

    .location-pulse {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(66, 133, 244, 0.3);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: location-pulse 2s infinite;
    }

    @keyframes location-pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }

    /* Info box */
    .info-box {
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 10px;
      max-width: 200px;
    }

    .info-box strong {
      display: block;
      margin-bottom: 6px;
      font-size: 11px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 3px;
    }

    .info-item {
      margin: 3px 0;
      line-height: 1.4;
    }

    /* Custom Popup Style */
    .custom-popup .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-height: 70vh;
      max-width: 95vw;
      width: auto;
    }

    .custom-popup .leaflet-popup-content {
      margin: 0;
      min-width: 280px;
      max-width: min(450px, 95vw);
      font-family: Arial, sans-serif;
      max-height: 70vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .custom-popup .leaflet-popup-close-button {
      display: none !important;
    }

    .custom-popup .leaflet-popup-tip-container {
      display: none;
    }

    .popup-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 12px;
      font-weight: bold;
      font-size: 15px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      touch-action: none;
    }

    .popup-header .close-btn {
      cursor: pointer;
      font-size: 24px;
      line-height: 1;
      padding: 5px 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      transition: all 0.3s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      min-width: 40px;
      text-align: center;
    }

    .popup-header .close-btn:active {
      background: rgba(255,255,255,0.4);
      transform: scale(0.95);
    }

    .popup-header.rdtr {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .popup-header.hutan {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .popup-header.persil {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .popup-header.sawah {
      background: linear-gradient(135deg, #8BC34A 0%, #CDDC39 100%);
    }

    .popup-header.kelerengan {
      background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
    }

    .popup-body {
      padding: 12px;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      -webkit-overflow-scrolling: touch;
    }

    .popup-body::-webkit-scrollbar {
      width: 6px;
    }

    .popup-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .popup-body::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }

    .popup-row {
      margin: 8px 0;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      display: flex;
      gap: 10px;
    }

    .popup-row:last-child {
      border-bottom: none;
    }

    .popup-label {
      font-weight: bold;
      color: #555;
      min-width: 100px;
      flex-shrink: 0;
      font-size: 12px;
    }

    .popup-value {
      color: #333;
      flex: 1;
      word-wrap: break-word;
      font-size: 13px;
    }

    .popup-loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .popup-error {
      color: #d32f2f;
      padding: 12px;
      background: #ffebee;
      border-radius: 6px;
      font-size: 13px;
      margin: 10px 0;
      line-height: 1.5;
    }

    .popup-warning {
      color: #f57c00;
      padding: 12px;
      background: #fff3e0;
      border-radius: 6px;
      font-size: 13px;
      margin: 10px 0;
      line-height: 1.5;
    }

    .popup-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .popup-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .popup-section-title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .popup-section-title.rdtr {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .popup-section-title.hutan {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .popup-section-title.persil {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .popup-section-title.sawah {
      background: linear-gradient(135deg, #8BC34A 0%, #CDDC39 100%);
    }

    .popup-section-title.kelerengan {
      background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
    }

    .feature-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 12px;
      gap: 10px;
    }

    .nav-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      min-width: 50px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:active:not(:disabled) {
      background: #5568d3;
      transform: scale(0.95);
    }

    .nav-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .nav-info {
      font-weight: bold;
      color: #333;
      font-size: 14px;
      flex: 1;
      text-align: center;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }

    .scroll-hint {
      text-align: center;
      padding: 10px;
      background: linear-gradient(to top, #f5f5f5, transparent);
      color: #666;
      font-size: 12px;
      border-top: 1px solid #ddd;
      position: sticky;
      bottom: 0;
      backdrop-filter: blur(5px);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .custom-layer-control, .basemap-control {
        max-width: calc(100vw - 80px);
      }

      .info-box {
        font-size: 9px;
        padding: 6px;
        max-width: 170px;
      }

      .legend-wms {
        max-width: calc(100vw - 80px);
        max-height: 250px;
      }

      .legend-wms img {
        max-width: 120px;
      }

      .popup-label {
        min-width: 85px;
        font-size: 11px;
      }

      .popup-value {
        font-size: 12px;
      }

      .custom-popup .leaflet-popup-content {
        min-width: 260px;
      }

      .leaflet-control-zoom a {
        width: 36px;
        height: 36px;
        line-height: 36px;
        font-size: 20px;
      }

      .leaflet-control-locate a {
        width: 36px;
        height: 36px;
      }

      .layer-control-body.expanded {
        max-height: 400px;
      }
    }

    @media (max-width: 480px) {
      .custom-layer-control, .basemap-control {
        min-width: 140px;
      }

      .layer-control-header, .basemap-control-header {
        font-size: 11px;
        padding: 8px 10px;
      }

      .layer-name, .basemap-item label {
        font-size: 11px;
      }

      .info-box {
        font-size: 8px;
        max-width: 150px;
      }

      .custom-popup .leaflet-popup-content {
        min-width: 240px;
      }

      .popup-header {
        font-size: 13px;
        padding: 12px 10px;
      }

      .nav-btn {
        min-width: 45px;
        min-height: 45px;
        padding: 10px 15px;
        font-size: 16px;
      }
    }

    @media (max-height: 500px) and (orientation: landscape) {
      .custom-popup .leaflet-popup-content-wrapper {
        max-height: 85vh;
      }

      .popup-body {
        max-height: calc(85vh - 60px);
      }

      .layer-control-body, .basemap-control-body {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>

<!-- Loading Overlay - Splash Screen -->
    <div id="loading-overlay" class="loading-overlay">
    <!-- Decorative Elements -->
    <div class="splash-decoration decoration-1"></div>
    <div class="splash-decoration decoration-2"></div>
    <div class="splash-decoration decoration-3"></div>
    
    <!-- Logo -->
    <div class="splash-logo">
        <div class="splash-icon">
          <img src="img/logo-bpn.png" alt="Logo BPN" style="width: 300px; height: auto;">
        </div>
    </div>

    <!-- Title -->
    <div class="splash-title">Peta Interaktif Seksi Penataan dan Pemberdayaan</div>
    <div class="splash-subtitle">Kantor Pertanahan Kabupaten Lombok Tengah</div>

    <div id="credit-map" style="
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 16px;
      z-index: 9999;
    ">
      ¬© Dikembangkan oleh: Alip Pangestu & Unsila Tammiya Artawan
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner"></div>
    <div class="loading-text">Memuat Data Peta...</div>
    <div class="loading-progress" id="loading-progress">Mohon tunggu...</div>
    </div>

  <!-- Modal Notifikasi Lokasi -->
  <div id="location-modal" class="location-modal hidden">
    <div class="location-modal-content">
      <div class="location-modal-header">
        <div class="location-modal-icon">üìç</div>
        <div class="location-modal-title">Izinkan Akses Lokasi</div>
      </div>
      <div class="location-modal-body">
        Aplikasi memerlukan akses lokasi Anda untuk menampilkan posisi Anda di peta dan memberikan pengalaman yang lebih baik.
      </div>
      <div class="location-modal-buttons">
        <button class="location-modal-btn secondary" onclick="dismissLocationModal()">Nanti Saja</button>
        <button class="location-modal-btn primary" onclick="requestLocation()">Izinkan</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    const map = L.map('map', {
      maxZoom: 22,
      zoomControl: true,
      tap: true,
      tapTolerance: 15
    }).setView([-8.7040, 116.2660], 13);

    let isBhumiLayerActive = true;
    let isRTRWLayerActive = false;
    let isRDTRLayerActive = false;
    let isHutanLayerActive = false;
    let isSawahLayerActive = false;
    let isKelerenganLayerActive = false;

    let highlightLayer = null;
    let currentPersilFeatures = [];
    let currentPersilIndex = 0;
    let currentPopup = null;
    let isLayerControlExpanded = false;
    let isBasemapControlExpanded = false;

    let locationMarker = null;
    let locationCircle = null;
    let currentBasemap = 'osm';

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    let rtrwLayerGroup = L.layerGroup();
    let rdtrLayerGroup = L.layerGroup();
    let sawahLayerGroup = L.layerGroup();
    let kelerenganLayerGroup = L.layerGroup();
    
    let rtrwGeoJSONData = null;
    let rdtrGeoJSONData = null;
    let sawahGeoJSONData = null;
    let kelerenganGeoJSONData = null;

    // ========== FUNGSI POPUP RTRW ==========
    function showRTRWPopup(feature, latlng) {
      const props = feature.properties;
      
      let content = `
        <div class="popup-header">
          <span>üèõÔ∏è RTRW</span>
          <span class="close-btn" onclick="closeCurrentPopup()">‚úï</span>
        </div>
        <div class="popup-body">
          <div class="popup-section">
            <div class="popup-section-title">üèõÔ∏è Informasi RTRW</div>
      `;
      
      for (let key in props) {
        if (props[key] !== null && props[key] !== '' && key !== 'warna') {
          const label = key.replace(/_/g, ' ').toUpperCase();
          let value = props[key];
          
          if ((key.toLowerCase().includes('luas') || key.toLowerCase().includes('area')) && !isNaN(value)) {
            value = parseFloat(value).toLocaleString('id-ID', {minimumFractionDigits: 2}) + ' Ha';
          }
          
          content += `
            <div class="popup-row">
              <span class="popup-label">${label}:</span>
              <span class="popup-value">${value}</span>
            </div>
          `;
        }
      }
      
      content += `
          </div>
          <div class="popup-row" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 8px;">
            <span class="popup-label">üìç Koordinat:</span>
            <span class="popup-value">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</span>
          </div>
        </div>
      `;
      
      currentPopup = L.popup({
        className: 'custom-popup',
        maxWidth: isMobile ? window.innerWidth - 20 : 450,
        minWidth: isMobile ? 260 : 300,
        closeButton: false,
        autoPan: true,
        autoPanPadding: [10, 10]
      })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(map);

      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, {
        style: {
          fillColor: 'transparent',
          color: '#ff0000',
          weight: 4,
          opacity: 1,
          dashArray: '10, 5'
        }
      }).addTo(map);
      if (highlightLayer.setZIndex) highlightLayer.setZIndex(999);
    }

    // ========== FUNGSI POPUP RDTR ==========
    function showRDTRPopup(feature, latlng) {
      const props = feature.properties;
      
      let content = `
        <div class="popup-header rdtr">
          <span>üèôÔ∏è RDTR</span>
          <span class="close-btn" onclick="closeCurrentPopup()">‚úï</span>
        </div>
        <div class="popup-body">
          <div class="popup-section">
            <div class="popup-section-title rdtr">üèôÔ∏è Informasi RDTR</div>
      `;
      
      for (let key in props) {
        if (props[key] !== null && props[key] !== '' && key !== 'warna') {
          const label = key.replace(/_/g, ' ').toUpperCase();
          let value = props[key];
          
          if ((key.toLowerCase().includes('luas') || key.toLowerCase().includes('area')) && !isNaN(value)) {
            value = parseFloat(value).toLocaleString('id-ID', {minimumFractionDigits: 2}) + ' m¬≤';
          }
          
          content += `
            <div class="popup-row">
              <span class="popup-label">${label}:</span>
              <span class="popup-value">${value}</span>
            </div>
          `;
        }
      }
      
      content += `
          </div>
          <div class="popup-row" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 8px;">
            <span class="popup-label">üìç Koordinat:</span>
            <span class="popup-value">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</span>
          </div>
        </div>
      `;
      
      currentPopup = L.popup({
        className: 'custom-popup',
        maxWidth: isMobile ? window.innerWidth - 20 : 450,
        minWidth: isMobile ? 260 : 300,
        closeButton: false,
        autoPan: true,
        autoPanPadding: [10, 10]
      })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(map);

      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, {
        style: {
          fillColor: 'transparent',
          color: '#ff0000',
          weight: 4,
          opacity: 1,
          dashArray: '10, 5'
        }
      }).addTo(map);
      if (highlightLayer.setZIndex) highlightLayer.setZIndex(999);
    }

    // ========== FUNGSI POPUP SAWAH ==========
    function showSawahPopup(feature, latlng) {
      const props = feature.properties;
      
      let content = `
        <div class="popup-header sawah">
          <span>üåæ Lahan Sawah Dilindungi</span>
          <span class="close-btn" onclick="closeCurrentPopup()">‚úï</span>
        </div>
        <div class="popup-body">
          <div class="popup-section">
            <div class="popup-section-title sawah">üåæ Informasi Lahan Sawah Dilindungi</div>
      `;
      
      for (let key in props) {
        if (props[key] !== null && props[key] !== '') {
          const label = key.replace(/_/g, ' ').toUpperCase();
          let value = props[key];
          
          if ((key.toLowerCase().includes('luas') || key.toLowerCase().includes('area')) && !isNaN(value)) {
            value = parseFloat(value).toLocaleString('id-ID', {minimumFractionDigits: 2}) + ' Ha';
          }
          
          content += `
            <div class="popup-row">
              <span class="popup-label">${label}:</span>
              <span class="popup-value">${value}</span>
            </div>
          `;
        }
      }
      
      content += `
          </div>
          <div class="popup-row" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 8px;">
            <span class="popup-label">üìç Koordinat:</span>
            <span class="popup-value">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</span>
          </div>
        </div>
      `;
      
      currentPopup = L.popup({
        className: 'custom-popup',
        maxWidth: isMobile ? window.innerWidth - 20 : 450,
        minWidth: isMobile ? 260 : 300,
        closeButton: false,
        autoPan: true,
        autoPanPadding: [10, 10]
      })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(map);

      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, {
        style: {
          fillColor: 'transparent',
          color: '#ff0000',
          weight: 4,
          opacity: 1,
          dashArray: '10, 5'
        }
      }).addTo(map);
      if (highlightLayer.setZIndex) highlightLayer.setZIndex(999);
    }

    // ========== FUNGSI POPUP KELERENGAN ==========
    function showKelerenganPopup(feature, latlng) {
      const props = feature.properties;
      
      let content = `
        <div class="popup-header kelerengan">
          <span>‚õ∞Ô∏è Kelerengan</span>
          <span class="close-btn" onclick="closeCurrentPopup()">‚úï</span>
        </div>
        <div class="popup-body">
          <div class="popup-section">
            <div class="popup-section-title kelerengan">‚õ∞Ô∏è Informasi Kelerengan</div>
      `;
      
      for (let key in props) {
        if (props[key] !== null && props[key] !== '') {
          const label = key.replace(/_/g, ' ').toUpperCase();
          let value = props[key];
          
          if (key.toLowerCase().includes('kelerengan') || key.toLowerCase().includes('slope')) {
            value = value + ' %';
          }
          
          if ((key.toLowerCase().includes('luas') || key.toLowerCase().includes('area')) && !isNaN(value)) {
            value = parseFloat(value).toLocaleString('id-ID', {minimumFractionDigits: 2}) + ' Ha';
          }
          
          content += `
            <div class="popup-row">
              <span class="popup-label">${label}:</span>
              <span class="popup-value">${value}</span>
            </div>
          `;
        }
      }
      
      content += `
          </div>
          <div class="popup-row" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 8px;">
            <span class="popup-label">üìç Koordinat:</span>
            <span class="popup-value">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</span>
          </div>
        </div>
      `;
      
      currentPopup = L.popup({
        className: 'custom-popup',
        maxWidth: isMobile ? window.innerWidth - 20 : 450,
        minWidth: isMobile ? 260 : 300,
        closeButton: false,
        autoPan: true,
        autoPanPadding: [10, 10]
      })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(map);

      if (highlightLayer) map.removeLayer(highlightLayer);
      highlightLayer = L.geoJSON(feature, {
        style: {
          fillColor: 'transparent',
          color: '#ff0000',
          weight: 4,
          opacity: 1,
          dashArray: '10, 5'
        }
      }).addTo(map);
      if (highlightLayer.setZIndex) highlightLayer.setZIndex(999);
    }

    // ========== LOAD GEOJSON ==========
    async function loadGeoJSONData() {
      const startTime = Date.now();
      const minimumDisplayTime = 5000;
      
      try {
        // Load RTRW
        document.getElementById('loading-progress').textContent = 'Memuat data RTRW...';
        const rtrwResponse = await fetch('data/rtrw.geojson');
        if (rtrwResponse.ok) {
          rtrwGeoJSONData = await rtrwResponse.json();
          console.log('‚úÖ RTRW loaded:', rtrwGeoJSONData.features.length, 'features');
          
          L.geoJSON(rtrwGeoJSONData, {
            style: function(feature) {
              return {
                fillColor: feature.properties.warna || '#95a5a6',
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.6
              };
            },
            onEachFeature: function(feature, layer) {
              layer.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                closeCurrentPopup();
                showRTRWPopup(feature, e.latlng);
              });

              layer.on('mouseover', function(e) {
                if (isRTRWLayerActive) {
                  layer.setStyle({
                    weight: 3,
                    color: '#667eea',
                    fillOpacity: 0.8
                  });
                }
              });

              layer.on('mouseout', function(e) {
                if (isRTRWLayerActive && (!currentPopup || currentPopup._source !== layer)) {
                  layer.setStyle({
                    weight: 1,
                    color: 'white',
                    fillOpacity: 0.6
                  });
                }
              });
            }
          }).addTo(rtrwLayerGroup);
        }
        
        // Load RDTR
        document.getElementById('loading-progress').textContent = 'Memuat data RDTR...';
        const rdtrResponse = await fetch('data/rdtr.geojson');
        if (rdtrResponse.ok) {
          rdtrGeoJSONData = await rdtrResponse.json();
          console.log('‚úÖ RDTR loaded:', rdtrGeoJSONData.features.length, 'features');
          
          L.geoJSON(rdtrGeoJSONData, {
            style: function(feature) {
              return {
                fillColor: feature.properties.warna || '#bdc3c7',
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.6
              };
            },
            onEachFeature: function(feature, layer) {
              layer.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                closeCurrentPopup();
                showRDTRPopup(feature, e.latlng);
              });

              layer.on('mouseover', function(e) {
                if (isRDTRLayerActive) {
                  layer.setStyle({
                    weight: 3,
                    color: '#f093fb',
                    fillOpacity: 0.8
                  });
                }
              });

              layer.on('mouseout', function(e) {
                if (isRDTRLayerActive && (!currentPopup || currentPopup._source !== layer)) {
                  layer.setStyle({
                    weight: 1,
                    color: 'white',
                    fillOpacity: 0.6
                  });
                }
              });
            }
          }).addTo(rdtrLayerGroup);
        }

        // Load Lahan Sawah Dilindungi
        document.getElementById('loading-progress').textContent = 'Memuat data Lahan Sawah Dilindungi...';
        const sawahResponse = await fetch('data/lsd.geojson');
        if (sawahResponse.ok) {
          sawahGeoJSONData = await sawahResponse.json();
          console.log('‚úÖ Lahan Sawah Dilindungi loaded:', sawahGeoJSONData.features.length, 'features');
          
          L.geoJSON(sawahGeoJSONData, {
            style: function(feature) {
              return {
                fillColor: '#8BC34A',
                weight: 1,
                opacity: 1,
                color: '#689F38',
                fillOpacity: 0.6
              };
            },
            onEachFeature: function(feature, layer) {
              layer.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                closeCurrentPopup();
                showSawahPopup(feature, e.latlng);
              });

              layer.on('mouseover', function(e) {
                if (isSawahLayerActive) {
                  layer.setStyle({
                    weight: 3,
                    color: '#33691E',
                    fillOpacity: 0.8
                  });
                }
              });

              layer.on('mouseout', function(e) {
                if (isSawahLayerActive && (!currentPopup || currentPopup._source !== layer)) {
                  layer.setStyle({
                    weight: 1,
                    color: '#689F38',
                    fillOpacity: 0.6
                  });
                }
              });
            }
          }).addTo(sawahLayerGroup);
        }

        // Load Kelerengan
        document.getElementById('loading-progress').textContent = 'Memuat data Kelerengan...';
        const kelerenganResponse = await fetch('data/kelerengan.geojson');
        if (kelerenganResponse.ok) {
          kelerenganGeoJSONData = await kelerenganResponse.json();
          console.log('‚úÖ Kelerengan loaded:', kelerenganGeoJSONData.features.length, 'features');
          
          L.geoJSON(kelerenganGeoJSONData, {
            style: function(feature) {
              return {
                fillColor: feature.properties.warna || '#bdc3c7',
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.6
              };
            },
            
            onEachFeature: function(feature, layer) {
              layer.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                closeCurrentPopup();
                showKelerenganPopup(feature, e.latlng);
              });

              layer.on('mouseover', function(e) {
                if (isKelerenganLayerActive) {
                  layer.setStyle({
                    weight: 3,
                    color: '#3E2723',
                    fillOpacity: 0.8
                  });
                }
              });

              layer.on('mouseout', function(e) {
                if (isKelerenganLayerActive && (!currentPopup || currentPopup._source !== layer)) {
                  layer.setStyle({
                    weight: 1,
                    color: '#795548',
                    fillOpacity: 0.6
                  });
                }
              });
            }
          }).addTo(kelerenganLayerGroup);
        }
        
        document.getElementById('loading-progress').textContent = 'Menyelesaikan...';
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, minimumDisplayTime - elapsedTime);
                setTimeout(() => {
          document.getElementById('loading-progress').textContent = 'Selesai! Selamat datang üéâ';
          
          const overlay = document.getElementById('loading-overlay');
          overlay.classList.add('fade-out');
          
          setTimeout(() => {
            overlay.classList.add('hidden');
          }, 600);
        }, remainingTime);
        
      } catch (error) {
        console.error('Error loading GeoJSON:', error);
        document.getElementById('loading-progress').textContent = 'Error: ' + error.message;
        setTimeout(() => {
          document.getElementById('loading-overlay').classList.add('hidden');
        }, 2000);
      }
    }

    loadGeoJSONData();

    // ========== MODAL LOKASI ==========
    window.dismissLocationModal = function() {
      document.getElementById('location-modal').classList.add('hidden');
      localStorage.setItem('locationPermissionAsked', 'true');
    };

    window.requestLocation = function() {
      document.getElementById('location-modal').classList.add('hidden');
      localStorage.setItem('locationPermissionAsked', 'true');
      getLocation();
    };

    if (isMobile && !localStorage.getItem('locationPermissionAsked')) {
      setTimeout(() => {
        document.getElementById('location-modal').classList.remove('hidden');
      }, 1000);
    }

    // ========== BASEMAPS ==========
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22,
      maxNativeZoom: 19,
      attribution: '&copy; OpenStreetMap',
      zIndex: 1
    }).addTo(map);

    const googleSat = L.tileLayer('https://www.google.com/maps/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 22,
      attribution: '&copy; Google',
      zIndex: 1
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 22,
      attribution: 'Esri',
      zIndex: 1
    });

    const bhumiLayer = L.tileLayer.wms('https://bhumi.atrbpn.go.id/mprx/service?', {
      layers: 'bhumi_persil',
      format: 'image/png',
      transparent: true,
      version: '1.3.0',
      crs: L.CRS.EPSG3857,
      maxZoom: 22,
      opacity: 0.8,
      zIndex: 10
    }).addTo(map);

    const hutanLayer = L.tileLayer(
      'https://geoportal.menlhk.go.id/server/rest/services/jsdgejawfvrdtasdt/KWS_HUTAN/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 22, opacity: 0.6, zIndex: 13 }
    );

    // ========== SWITCH BASEMAP ==========
    window.switchBasemap = function(basemapName) {
      document.getElementById('basemap-osm').classList.remove('active');
      document.getElementById('basemap-satellite').classList.remove('active');
      document.getElementById('basemap-google').classList.remove('active');
      document.getElementById('basemap-' + basemapName).classList.add('active');
      document.getElementById('radio-' + basemapName).checked = true;
      
      if (basemapName === 'osm') {
        if (map.hasLayer(satellite)) map.removeLayer(satellite);
        if (map.hasLayer(googleSat)) map.removeLayer(googleSat);
        if (!map.hasLayer(osm)) map.addLayer(osm);
        osm.setZIndex(1);
        currentBasemap = 'osm';
      } else if (basemapName === 'satellite') {
        if (map.hasLayer(osm)) map.removeLayer(osm);
        if (map.hasLayer(googleSat)) map.removeLayer(googleSat);
        if (!map.hasLayer(satellite)) map.addLayer(satellite);
        satellite.setZIndex(1);
        currentBasemap = 'satellite';
      } else if (basemapName === 'google') {
        if (map.hasLayer(osm)) map.removeLayer(osm);
        if (map.hasLayer(satellite)) map.removeLayer(satellite);
        if (!map.hasLayer(googleSat)) map.addLayer(googleSat);
        googleSat.setZIndex(1);
        currentBasemap = 'google';
      }

      if (map.hasLayer(bhumiLayer)) bhumiLayer.setZIndex(10);
    };

    // ========== GEOLOCATION ==========
    L.Control.Locate = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#';
        link.title = 'Lokasi Saya';
        link.innerHTML = 'üìç';
        link.id = 'locate-btn';
        L.DomEvent.on(link, 'click', function(e) {
          L.DomEvent.preventDefault(e);
          L.DomEvent.stopPropagation(e);
          getLocation();
        });
        return container;
      }
    });

    new L.Control.Locate().addTo(map);

    function getLocation() {
      const btn = document.getElementById('locate-btn');
      if (!navigator.geolocation) {
        alert('Geolocation tidak didukung');
        return;
      }
      btn.classList.add('loading');
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          if (locationMarker) map.removeLayer(locationMarker);
          if (locationCircle) map.removeLayer(locationCircle);
          const locationIcon = L.divIcon({
            className: 'location-marker',
            html: '<div class="location-pulse"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          locationMarker = L.marker([lat, lng], { icon: locationIcon, zIndex: 1000 }).addTo(map);
          locationCircle = L.circle([lat, lng], {
            radius: accuracy,
            color: '#4285f4',
            fillColor: '#4285f4',
            fillOpacity: 0.15,
            weight: 2,
            zIndex: 999
          }).addTo(map);
          map.setView([lat, lng], 16);
          locationMarker.bindPopup(`
            <div style="text-align: center;">
              <strong>üìç Lokasi Anda</strong><br>
              <small>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}<br>Akurasi: ¬±${Math.round(accuracy)}m</small>
            </div>
          `).openPopup();
          btn.classList.remove('loading');
          btn.classList.add('active');
          setTimeout(() => btn.classList.remove('active'), 3000);
        },
        function(error) {
          btn.classList.remove('loading');
          alert('Error mendapatkan lokasi');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // ========== LAYER CONTROL ==========
    L.Control.CustomLayers = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control custom-layer-control');
        container.innerHTML = `
          <div class="layer-control-header" onclick="toggleLayerControl()">
            <span>üóÇÔ∏è Layer</span>
            <span class="toggle-icon" id="layer-toggle-icon">‚ñº</span>
          </div>
          <div class="layer-control-body" id="layer-control-body">
            
            <div class="layer-item active" id="layer-persil">
              <div class="layer-item-header" onclick="toggleLayer('persil')">
                <input type="checkbox" class="layer-checkbox" id="check-persil" checked onchange="toggleLayer('persil')">
                <span class="layer-name">üìç Persil Tanah</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-persil" min="0" max="100" value="80">
                  <span class="opacity-value" id="value-persil">80%</span>
                </div>
              </div>
            </div>

            <div class="layer-item" id="layer-rtrw">
              <div class="layer-item-header" onclick="toggleLayer('rtrw')">
                <input type="checkbox" class="layer-checkbox" id="check-rtrw" onchange="toggleLayer('rtrw')">
                <span class="layer-name">üèõÔ∏è RTRW</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-rtrw" min="0" max="100" value="60">
                  <span class="opacity-value" id="value-rtrw">60%</span>
                </div>
              </div>
            </div>

            <div class="layer-item" id="layer-rdtr">
              <div class="layer-item-header" onclick="toggleLayer('rdtr')">
                <input type="checkbox" class="layer-checkbox" id="check-rdtr" onchange="toggleLayer('rdtr')">
                <span class="layer-name">üèôÔ∏è RDTR</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-rdtr" min="0" max="100" value="60">
                  <span class="opacity-value" id="value-rdtr">60%</span>
                </div>
              </div>
            </div>

            <div class="layer-item" id="layer-hutan">
              <div class="layer-item-header" onclick="toggleLayer('hutan')">
                <input type="checkbox" class="layer-checkbox" id="check-hutan" onchange="toggleLayer('hutan')">
                <span class="layer-name">üå≤ Kawasan Hutan</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-hutan" min="0" max="100" value="60">
                  <span class="opacity-value" id="value-hutan">60%</span>
                </div>
              </div>
            </div>

            <div class="layer-item" id="layer-sawah">
              <div class="layer-item-header" onclick="toggleLayer('sawah')">
                <input type="checkbox" class="layer-checkbox" id="check-sawah" onchange="toggleLayer('sawah')">
                <span class="layer-name">üåæ Lahan Sawah Dilindungi</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-sawah" min="0" max="100" value="60">
                  <span class="opacity-value" id="value-sawah">60%</span>
                </div>
              </div>
            </div>

            <div class="layer-item" id="layer-kelerengan">
              <div class="layer-item-header" onclick="toggleLayer('kelerengan')">
                <input type="checkbox" class="layer-checkbox" id="check-kelerengan" onchange="toggleLayer('kelerengan')">
                <span class="layer-name">‚õ∞Ô∏è Kelerengan</span>
              </div>
              <div class="layer-opacity">
                <div class="opacity-slider-container">
                  <label>Opacity:</label>
                  <input type="range" id="opacity-kelerengan" min="0" max="100" value="60">
                  <span class="opacity-value" id="value-kelerengan">60%</span>
                </div>
              </div>
            </div>

          </div>
        `;
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        return container;
      }
    });

    new L.Control.CustomLayers().addTo(map);

    L.Control.Basemap = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control basemap-control');
        container.innerHTML = `
          <div class="basemap-control-header" onclick="toggleBasemapControl()">
            <span>üó∫Ô∏è Peta Dasar</span>
            <span class="toggle-icon" id="basemap-toggle-icon">‚ñº</span>
          </div>
          <div class="basemap-control-body" id="basemap-control-body">
            
            <div class="basemap-item active" id="basemap-osm" onclick="switchBasemap('osm')">
              <input type="radio" name="basemap" id="radio-osm" checked>
              <label for="radio-osm">üó∫Ô∏è OpenStreetMap</label>
            </div>

            <div class="basemap-item" id="basemap-google" onclick="switchBasemap('google')">
              <input type="radio" name="basemap" id="radio-google">
              <label for="radio-google">üõ∞Ô∏è Google Satellite</label>
            </div>

            <div class="basemap-item" id="basemap-satellite" onclick="switchBasemap('satellite')">
              <input type="radio" name="basemap" id="radio-satellite">
              <label for="radio-satellite">üõ∞Ô∏è Satellite</label>
            </div>

          </div>
        `;
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        return container;
      }
    });

    new L.Control.Basemap().addTo(map);

    window.toggleLayerControl = function() {
      isLayerControlExpanded = !isLayerControlExpanded;
      const body = document.getElementById('layer-control-body');
      const icon = document.getElementById('layer-toggle-icon');
      if (isLayerControlExpanded) {
        body.classList.add('expanded');
        icon.classList.add('expanded');
      } else {
        body.classList.remove('expanded');
        icon.classList.remove('expanded');
      }
    };

    window.toggleBasemapControl = function() {
      isBasemapControlExpanded = !isBasemapControlExpanded;
      const body = document.getElementById('basemap-control-body');
      const icon = document.getElementById('basemap-toggle-icon');
      if (isBasemapControlExpanded) {
        body.classList.add('expanded');
        icon.classList.add('expanded');
      } else {
        body.classList.remove('expanded');
        icon.classList.remove('expanded');
      }
    };

    window.toggleLayer = function(layerName) {
      const checkbox = document.getElementById('check-' + layerName);
      const layerItem = document.getElementById('layer-' + layerName);
      
      if (event.target.type !== 'checkbox') {
        checkbox.checked = !checkbox.checked;
      }
      
      const isActive = checkbox.checked;
      
      if (isActive) {
        layerItem.classList.add('active');
      } else {
        layerItem.classList.remove('active');
      }
      
      switch(layerName) {
        case 'persil':
          isBhumiLayerActive = isActive;
          if (isActive) {
            map.addLayer(bhumiLayer);
            bhumiLayer.setZIndex(10);
          } else {
            map.removeLayer(bhumiLayer);
          }
          break;
        case 'rtrw':
          isRTRWLayerActive = isActive;
          if (isActive) {
            map.addLayer(rtrwLayerGroup);
            rtrwLayerGroup.setZIndex(11);
          } else {
            map.removeLayer(rtrwLayerGroup);
          }
          break;
        case 'rdtr':
          isRDTRLayerActive = isActive;
          if (isActive) {
            map.addLayer(rdtrLayerGroup);
            rdtrLayerGroup.setZIndex(12);
          } else {
            map.removeLayer(rdtrLayerGroup);
          }
          break;
        case 'hutan':
          isHutanLayerActive = isActive;
          if (isActive) {
            map.addLayer(hutanLayer);
            hutanLayer.setZIndex(13);
          } else {
            map.removeLayer(hutanLayer);
          }
          break;
        case 'sawah':
          isSawahLayerActive = isActive;
          if (isActive) {
            map.addLayer(sawahLayerGroup);
            sawahLayerGroup.setZIndex(14);
          } else {
            map.removeLayer(sawahLayerGroup);
          }
          break;
        case 'kelerengan':
          isKelerenganLayerActive = isActive;
          if (isActive) {
            map.addLayer(kelerenganLayerGroup);
            kelerenganLayerGroup.setZIndex(15);
          } else {
            map.removeLayer(kelerenganLayerGroup);
          }
          break;
      }
      
      updateMapCursor();
    };

    setTimeout(() => {
      document.getElementById('opacity-persil').addEventListener('input', function(e) {
        const value = e.target.value;
        bhumiLayer.setOpacity(value / 100);
        document.getElementById('value-persil').textContent = value + '%';
      });

      document.getElementById('opacity-rtrw').addEventListener('input', function(e) {
        const value = e.target.value;
        rtrwLayerGroup.eachLayer(function(layer) {
          if (layer.setStyle) {
            layer.setStyle({ fillOpacity: value / 100 });
          }
        });
        document.getElementById('value-rtrw').textContent = value + '%';
      });

      document.getElementById('opacity-rdtr').addEventListener('input', function(e) {
        const value = e.target.value;
        rdtrLayerGroup.eachLayer(function(layer) {
          if (layer.setStyle) {
            layer.setStyle({ fillOpacity: value / 100 });
          }
        });
        document.getElementById('value-rdtr').textContent = value + '%';
      });

      document.getElementById('opacity-hutan').addEventListener('input', function(e) {
        const value = e.target.value;
        hutanLayer.setOpacity(value / 100);
        document.getElementById('value-hutan').textContent = value + '%';
      });

      document.getElementById('opacity-sawah').addEventListener('input', function(e) {
        const value = e.target.value;
        sawahLayerGroup.eachLayer(function(layer) {
          if (layer.setStyle) {
            layer.setStyle({ fillOpacity: value / 100 });
          }
        });
        document.getElementById('value-sawah').textContent = value + '%';
      });

      document.getElementById('opacity-kelerengan').addEventListener('input', function(e) {
        const value = e.target.value;
        kelerenganLayerGroup.eachLayer(function(layer) {
          if (layer.setStyle) {
            layer.setStyle({ fillOpacity: value / 100 });
          }
        });
        document.getElementById('value-kelerengan').textContent = value + '%';
      });
    }, 100);

    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend-wms");
      const bhumiLegendUrl = "https://bhumi.atrbpn.go.id/expapi/bhumigs/umum/wms?SERVICE=WMS&REQUEST=GetLegendGraphic&VERSION=1.3.0&FORMAT=image/png&WIDTH=12&HEIGHT=12&LAYER=umum:Persil&STYLE=&LEGEND_OPTIONS=fontName:Inter;fontSize:5;dpi:200;bgColor:0xFFFFFF;fontColor:0x353432";
      div.innerHTML = `<h4>üìã Legenda</h4><img src="${bhumiLegendUrl}" alt="Legenda" onerror="this.style.display='none'">`;
      return div;
    };
    legend.addTo(map);

    function formatNomorHak(nomor) {
      if (!nomor) return '-';
      const nomorStr = String(nomor).replace(/\D/g, '');
      if (nomorStr.length >= 14) {
        return `${nomorStr.substring(0, 8)}.${nomorStr.substring(8, 9)}.${nomorStr.substring(9, 14)}`;
      } else if (nomorStr.length >= 9) {
        return `${nomorStr.substring(0, 8)}.${nomorStr.substring(8, 9)}.${nomorStr.substring(9)}`;
      }
      return nomor;
    }

    function highlightAndZoomToPersil(feature) {
      if (highlightLayer) map.removeLayer(highlightLayer);
      if (feature.geometry) {
        highlightLayer = L.geoJSON(feature, {
          style: {
            fillColor: 'transparent',
            color: '#ff0000',
            weight: 4,
            opacity: 1,
            dashArray: '10, 5'
          }
        }).addTo(map);
        if (highlightLayer.setZIndex) highlightLayer.setZIndex(999);
        const bounds = highlightLayer.getBounds();
        map.fitBounds(bounds, {
          padding: isMobile ? [30, 30] : [50, 50],
          maxZoom: 18
        });
      }
    }

    window.navigatePersil = function(direction) {
      let newIndex = currentPersilIndex;
      if (direction === 'prev' && currentPersilIndex > 0) {
        newIndex = currentPersilIndex - 1;
      } else if (direction === 'next' && currentPersilIndex < currentPersilFeatures.length - 1) {
        newIndex = currentPersilIndex + 1;
      }
      if (newIndex !== currentPersilIndex) {
        updatePersilPopup(newIndex);
      }
    };

    function createPersilPopupContent(index = 0) {
      if (currentPersilFeatures.length === 0) return '';
      const feature = currentPersilFeatures[index];
      const properties = feature.properties;
      const total = currentPersilFeatures.length;
      highlightAndZoomToPersil(feature);
      const nib = properties.nib || properties.NIB || properties.nomor_identitas_bidang || '-';
      const tipeHak = properties.tipe_hak || properties.TIPE_HAK || properties.jenis_hak || '-';
      const nomorHak = formatNomorHak(properties.nomor || properties.NOMOR || properties.nomor_hak || '');
      const luas = properties.luas || properties.LUAS || properties.luas_bidang || 0;
      const tahun = properties.tahun || properties.TAHUN || properties.tahun_terbit || '-';
      let content = `<div class="popup-section"><div class="popup-section-title persil">üìç Data Bidang Tanah</div>`;
      if (total > 1) {
        content += `
          <div class="feature-navigation">
            <button class="nav-btn" id="btn-prev-persil" ${index === 0 ? 'disabled' : ''}>‚óÑ</button>
            <span class="nav-info">${index + 1} dari ${total}</span>
            <button class="nav-btn" id="btn-next-persil" ${index === total - 1 ? 'disabled' : ''}>‚ñ∫</button>
          </div>
        `;
      }
      content += `
        <div class="popup-row"><span class="popup-label">üÜî NIB:</span><span class="popup-value">${nib}</span></div>
        <div class="popup-row"><span class="popup-label">üìã Tipe Hak:</span><span class="popup-value">${tipeHak}</span></div>
        <div class="popup-row"><span class="popup-label">üìÑ No. Hak:</span><span class="popup-value">${nomorHak}</span></div>
        <div class="popup-row"><span class="popup-label">üìè Luas:</span><span class="popup-value">${parseFloat(luas).toLocaleString('id-ID', {minimumFractionDigits: 0, maximumFractionDigits: 2})} m¬≤</span></div>
        <div class="popup-row"><span class="popup-label">üìÖ Tahun:</span><span class="popup-value">${tahun}</span></div>
      </div>`;
      return content;
    }

    function attachNavigationListeners() {
      setTimeout(() => {
        const prevBtn = document.getElementById('btn-prev-persil');
        const nextBtn = document.getElementById('btn-next-persil');
        if (prevBtn) {
          prevBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            navigatePersil('prev');
          };
        }
        if (nextBtn) {
          nextBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            navigatePersil('next');
          };
        }
      }, 100);
    }

    function updatePersilPopup(newIndex) {
      currentPersilIndex = newIndex;
      if (currentPopup) {
        const newContent = createPersilPopupContent(currentPersilIndex);
        const fullContent = `
          <div class="popup-header persil">
            <span>üìç Informasi Lokasi</span>
            <span class="close-btn" onclick="closeCurrentPopup()">‚úï</span>
          </div>
          <div class="popup-body">${newContent}</div>
        `;
        currentPopup.setContent(fullContent);
        attachNavigationListeners();
      }
    }

    window.closeCurrentPopup = function() {
      if (currentPopup) map.closePopup(currentPopup);
      if (highlightLayer) {
        map.removeLayer(highlightLayer);
        highlightLayer = null;
      }
      currentPersilFeatures = [];
      currentPersilIndex = 0;
      currentPopup = null;
    };

    function queryBhumiPersil(latlng) {
      const point = map.latLngToContainerPoint(latlng);
      const size = map.getSize();
      const bounds = map.getBounds();
      const sw = map.options.crs.project(bounds.getSouthWest());
      const ne = map.options.crs.project(bounds.getNorthEast());
      const bbox = [sw.x, sw.y, ne.x, ne.y].join(',');
      const params = {
        SERVICE: 'WMS', VERSION: '1.3.0', REQUEST: 'GetFeatureInfo',
        LAYERS: 'bhumi_persil', QUERY_LAYERS: 'bhumi_persil',
        INFO_FORMAT: 'application/json', FEATURE_COUNT: 50,
        I: Math.floor(point.x), J: Math.floor(point.y),
        CRS: 'EPSG:3857', WIDTH: size.x, HEIGHT: size.y, BBOX: bbox
      };
      const queryString = Object.keys(params).map(key => `${key}=${encodeURIComponent(params[key])}`).join('&');
      const url = 'https://bhumi.atrbpn.go.id/mprx/service?' + queryString;
      return fetch(url).then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      }).catch(error => {
        console.error('Error querying BHUMI Persil:', error);
        return null;
      });
    }

    function queryKawasanHutan(latlng) {
      const earthRadius = 6378137;
      const lat = Math.max(Math.min(latlng.lat, 89.99999), -89.99999);
      const x = earthRadius * latlng.lng * Math.PI / 180;
      const y = earthRadius * Math.log(Math.tan((90 + lat) * Math.PI / 360));
      const identifyUrl = 'https://geoportal.menlhk.go.id/server/rest/services/jsdgejawfvrdtasdt/KWS_HUTAN/MapServer/identify';
      const params = {
        f: 'json',
        geometry: `{"x":${x},"y":${y},"spatialReference":{"wkid":102100}}`,
        geometryType: 'esriGeometryPoint', sr: '102100', layers: 'all',
        tolerance: 5, mapExtent: map.getBounds().toBBoxString(),
        imageDisplay: `${map.getSize().x},${map.getSize().y},96`,
        returnGeometry: true
      };
      const queryString = Object.keys(params).map(key => `${key}=${encodeURIComponent(params[key])}`).join('&');
      return fetch(`${identifyUrl}?${queryString}`).then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      }).catch(error => {
        console.error('Error querying Kawasan Hutan:', error);
        return null;
      });
    }

    function updateMapCursor() {
      if (isBhumiLayerActive || isRTRWLayerActive || isRDTRLayerActive || isHutanLayerActive || isSawahLayerActive || isKelerenganLayerActive) {
        document.getElementById('map').classList.add('clickable');
      } else {
        document.getElementById('map').classList.remove('clickable');
      }
    }

    map.on('click', function(e) {
      const activeLayers = [];
      if (isBhumiLayerActive) activeLayers.push('Persil');
      if (isHutanLayerActive) activeLayers.push('Hutan');

      if (activeLayers.length === 0) return;

      const queries = [];

      if (isBhumiLayerActive) queries.push(queryBhumiPersil(e.latlng).then(data => ({ type: 'PERSIL', data })));
      if (isHutanLayerActive) queries.push(queryKawasanHutan(e.latlng).then(data => ({ type: 'HUTAN', data })));

      if (queries.length === 0) return;

      closeCurrentPopup();

      const loadingPopup = L.popup({ 
        className: 'custom-popup',
        maxWidth: isMobile ? window.innerWidth - 20 : 450,
        minWidth: isMobile ? 260 : 300,
        closeButton: false, autoPan: true, autoPanPadding: [10, 10]
      }).setLatLng(e.latlng).setContent(`
        <div class="popup-header"><span>üìç Memuat Data...</span><span class="close-btn" onclick="closeCurrentPopup()">‚úï</span></div>
        <div class="popup-body"><div class="popup-loading"><div class="spinner"></div><p>Mohon tunggu...</p></div></div>
      `).openOn(map);

      currentPopup = loadingPopup;

      Promise.all(queries).then(results => {
        let popupBody = '';
        let hasData = false;
        let sectionsCount = 0;

        results.forEach(result => {
          if (result.type === 'PERSIL' && result.data && result.data.features && result.data.features.length > 0) {
            hasData = true;
            sectionsCount++;
            currentPersilFeatures = result.data.features;
            currentPersilIndex = 0;
            popupBody += createPersilPopupContent(0);
          }

          if (result.type === 'HUTAN' && result.data && result.data.results && result.data.results.length > 0) {
            hasData = true;
            sectionsCount++;
            const feature = result.data.results[0];
            const attributes = feature.attributes;
            popupBody += `<div class="popup-section"><div class="popup-section-title hutan">üå≤ Kawasan Hutan</div>`;
            for (let key in attributes) {
              if (attributes.hasOwnProperty(key) && attributes[key] !== null && attributes[key] !== '') {
                let label = key.replace(/_/g, ' ').toUpperCase();
                let value = attributes[key];
                if (key.toLowerCase().includes('luas') && !isNaN(value)) {
                  value = parseFloat(value).toLocaleString('id-ID') + ' Ha';
                }
                popupBody += `<div class="popup-row"><span class="popup-label">${label}:</span><span class="popup-value">${value}</span></div>`;
              }
            }
            popupBody += `</div>`;
          }
        });

        if (!hasData) {
          popupBody = `<div class="popup-error">‚ö†Ô∏è Tidak ada data di lokasi ini.</div>`;
        }

        popupBody += `<div class="popup-row" style="border-top: 2px solid #ddd; padding-top: 8px; margin-top: 10px;"><span class="popup-label">üìç Koordinat:</span><span class="popup-value">${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</span></div>`;
        const scrollHint = sectionsCount > 1 ? '<div class="scroll-hint">‚¨áÔ∏è Geser untuk melihat lebih banyak ‚¨áÔ∏è</div>' : '';
        const popupContent = `<div class="popup-header"><span>üìç Informasi</span><span class="close-btn" onclick="closeCurrentPopup()">‚úï</span></div><div class="popup-body">${popupBody}</div>${scrollHint}`;
        loadingPopup.setContent(popupContent);
        attachNavigationListeners();
      });
    });

    map.on('popupclose', function() {
      if (highlightLayer) {
        map.removeLayer(highlightLayer);
        highlightLayer = null;
      }
      currentPersilFeatures = [];
      currentPersilIndex = 0;
      currentPopup = null;
    });

    const infoBox = L.control({ position: "bottomleft" });
    infoBox.onAdd = function () {
      const div = L.DomUtil.create("div", "info-box");
      div.id = 'info-box-content';
      div.innerHTML = `
        <strong>üìä Info Peta</strong>
        <div class="info-item">üìç <span id="coords">-</span></div>
        <div class="info-item">üîç Zoom: <span id="zoom-level">${map.getZoom()}</span></div>
        <div class="info-item" style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #ddd;">üí° Klik peta untuk info detail</div>
      `;
      return div;
    };
    infoBox.addTo(map);

    map.on('mousemove', function(e) {
      const coordsEl = document.getElementById('coords');
      if (coordsEl) coordsEl.textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
    });

    map.on('zoomend', function() {
      const zoomEl = document.getElementById('zoom-level');
      if (zoomEl) zoomEl.textContent = map.getZoom();
    });

    L.control.scale({ metric: true, imperial: false, position: 'bottomleft', maxWidth: isMobile ? 100 : 150 }).addTo(map);

    updateMapCursor();

    console.log('üó∫Ô∏è Peta berhasil dimuat!');
    console.log('‚úÖ RTRW, RDTR, Lahan Sawah Dilindungi & Kelerengan dari GeoJSON lokal!');
    console.log('üìÅ Pastikan file berikut ada:');
    console.log('   - data/rtrw.geojson');
    console.log('   - data/rdtr.geojson');
    console.log('   - data/lsd.geojson');
    console.log('   - data/kelerengan.geojson');
  </script>
  <script>
  // Auto adjust viewport scale untuk mobile
  (function() {
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      // Untuk mobile, set initial scale ke 0.75
      var viewport = document.querySelector("meta[name=viewport]");
      if (viewport) {
        viewport.content = "width=device-width, initial-scale=0.75, maximum-scale=0.75, user-scalable=no";
      }
    }
  })();
  </script>
</body>
</html>
